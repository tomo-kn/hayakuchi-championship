<h1 class="text-center mt-5"><%= @sentence.content %></h1>
<p>3回繰り返そう！</p>

<a href="/practices/<%= @sentence.id %>/result">結果を見る</a>
<p></p>
<a href="/practices">一覧ページへ戻る</a>

<div><button id="button">●</button></div>
<a id="sound"></a>
<div id="text"></div>
<div id="speeching"></div>

<script>
const recognition = new webkitSpeechRecognition();

const btn = document.getElementById('button');
const text = document.getElementById('text');
const speeching = document.getElementById('speeching');
var recording = false;

recognition.lang = 'ja';
recognition.interimResults = true;
recognition.continuous = false;

const sound = document.getElementById('sound');
var mediaRecorder;

btn.addEventListener('click', function () {
  if(recording) {
    recording = false;
    recognition.stop();
  }else{
    recognition.start();
    recording = true;
    btn.textContent = "■";
    sound.textCountent = "Recording...";
    navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(hundleSuccess);
  }
});

recognition.onresult = function(e){
  speeching.innerText = '';
  for (let i = e.resultIndex; (i < e.results.length); i++){
    let result = e.results[i][0].transcript;
    if(e.results[i].isFinal){
      text.innerHTML += '<div>' + result + '</div>';
      console.log(e);
    }else{
      speeching.innerText += result;
      scrollBy(0, 50);
      console.log(e);
    }
  }
};

recognition.onend = function(){
  if(recording){
    recognition.start();
  }else{
    btn.textContent = "●";
    mediaRecorder.stop();
  }
};

var hundleSuccess = function(stream){
  var recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream);

  mediaRecorder.ondataavailable = function(e){
    if (e.data.size > 0){
      recordedChunks.push(e.data);
    }
  };

  mediaRecorder.onstop = function(){
    var d = new Date();
    var fn = ((((d.getFullYear()*100 + d.getMonth()+1)*100 + d.getDate())*100+ d.getHours())*100 + d.getMinutes())*100 + d.getMinutes();
    sound.href = URL.createObjectURL(new Blob(recordedChunks));
    sound.textContent = "Get Audio";
    sound.download = fn+".webm";
  };
  mediaRecorder.start();
};


recognition.addEventListener('soundstart', function() {
  console.log('Some sound is being received');
});

recognition.addEventListener('soundend', function(event) {
  console.log('Sound has stopped being received');
});


</script>